---
title: 'Jacob Data Cleaning'
date: 3/11/19
output:
  html_document:
    df_print: paged
---


# Libraries
```{r libs, warning=FALSE, message=FALSE}
library(tidyverse)
```


# Function Defintions:
```{r functs}
bool_idx <- function ( to_idx, match){
  # Function takes two vectors and returns boolean index for first vector so you can only keep whats in both. 
  # I made this bc I couldnt index rows with the columns names it was hard. 
  
  index <-  c()
  
  # I couldn't figure out how to index columns v rows so this is what I got.
  for (i in to_idx) {
    
    if (i %in% match){
      index <- c(index,TRUE)
    }
    else {
      index <- c(index,FALSE)
    }
  }
  
  return(index)
}
```




# Read in Data

We have stored in the data directory of the project directory 

```{r readin, message=FALSE}
expression <- as.data.frame((read.table("../data/expression.txt", row.names=1 )))

# Needed as the first two column names start with a number so they get mucked up.
names(expression)[1] <- "184A1"
names(expression)[2] <- "600MPE"

subtypes <- read_delim("../data/subtypes.txt", "\t", escape_double = FALSE, trim_ws = TRUE)

truth_set <-  as.data.frame((read.table("../data/training_set_answers.txt", row.names=1 )))
```



# Prelim EDA

Now I am interested in how many different features present in our dataset. 

I will look at how many gene expression features and subtypes as well as all the truth set


### Gene Expressilon Features
```{r gene_exp}
expression %>% head() %>% glimpse()
dim(expression)
```

Looking at the raw expression data it is clear that it is raw data that has not been normalized yet. 

Normalization technqiues will be applied to the data dependent on which model we intend to use. 

There are 18632 distinct features and 39 observations in the dataset. 

Each observation is the the cell type which will allow us to extrapolate to each cell type response to the approprate drug treatment. Additonally each gene expression feature is annotated with the gene or region name that gives us meaninful information. 

### Cell Types
```{r count_cell_types}
subtypes %>% glimpse()
subtypes %>% distinct(subtype)
```

This dataset linked the celllines to their subtype distinction. Each observation is a unique instance of cell line name with its corresponding subtype classification

Based on the training data that was published there are only 4 subtypes present in this database.
In the original study the **PAPER** discussed 6 subtypes being present in the dataset. This indicates that there are other subtypes that were randomly placed into the testing data. This lack of information puts us at a disadvantage as we do not have data for these distinct types. 
> Thus, our model must be generalizable to predict drug response with cell subtypes that it has not been trained on. 

# DISCUSSION ON THE BIOLOGY OF THESE CELL TYPES AND IF IT IS LIKELY OUR MODEL WILL CAPTURE IT.


```{r view_truth}
truth_set
dim(truth_set) # Convert this to a table
names(truth_set) # Show all the drugs were in study
```

We can observe that we are predict drug responsivenes to 25 cell lines to 12 different drugs. Names are present in the above output. 

Since, there are only 25 cell lines present in our training truth set, we will only build our model to predect these 25 cell lines. THis must be done as we do not have outcomes for these cell lines outside of this truth set. I will remove the cell lines not in the expression set. 


## Processing dataset

Use the truth_set to create a vector to decide if the expression set data is kept. 

```{r clean_exp}

full <- names(expression)
truth_name <- rownames(truth_set)
exp_idx <- bool_idx(full,truth_name)


expression <- expression[,exp_idx]
dim(expression)

# I will also seperate the subtypes this way. 
sub_names <- subtypes %>% pull(cellline)
sub_idx <- bool_idx(sub_names,truth_name)
subtypes <- subtypes[sub_idx,]
dim(subtypes)
```

Originally only 24 samples were retained but upon futher investiagtion there was an X in front of all cellines with integers as the first character. 
Only 184A1 is present in the truth set but does not have corresponding expression data.  

> All 25 cell lines from the truth set were present in the training data. Subtypes were also seperated the same way. 


Here is the raw data showing what happened. 
```{r find_missing}

full <- names(as.data.frame((read.table("../data/expression.txt", row.names=1 ))))
truth <- rownames(truth_set)

# I couldn't figure out how to index columns v rows so this is what I got.
for (t in truth) {
  
  if (t %in% full){
    
  }
  else {
    print(t)
  }
}
```


Now I will seperate the data into a tab seperated file for each of the 3 input datasets.

Note: the truth set does not need to be modified as it includes all of the 

```{r write_out}
# Double check all the dataframs have correct observations
dim(expression)
dim(subtypes)
dim(truth_set)

# Write expression
write.table(expression, file= '../data/clean_expression.txt', sep= '\t', na = 'NA')
# Write subtypes
write_tsv(subtypes, '../data/clean_subtypes.txt', na = "NA")
# Write training set answers
write.table(truth_set, '../data/clean_training_answers.txt', sep= '\t', na = "NA")
```

# New Import Commands 
```{r check_write, message=FALSE}

test_exp <- as.data.frame((read.table("../data/clean_expression.txt", row.names=1 )))

test_sub <- read_tsv("../data/clean_subtypes.txt")

test_truth <-  as.data.frame((read.table("../data/clean_training_answers.txt", row.names=1 )))

dim(test_exp)
dim(test_sub)
dim(test_truth)

```



